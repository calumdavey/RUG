---
title: "R tables easy to make?"
subtitle: "RUG LSHTM"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document:
    reference_docx: reference.docx
    toc: Yes
---


```{r setup, include = F, echo = F}

# Chunk options ---- 

# include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in the chunk, and the results can be used by other chunks.
# echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to embed figures.
# message = FALSE prevents messages that are generated by code from appearing in the finished output
# warning = FALSE prevents warnings that are generated by code from appearing in the finished output.
# fig.cap = "..." adds a caption to graphical results.
# eval = FALSE does not run the code chunk

# global options ----
# > code chunk options ----

# knitr::opts_chunk$set(
#   comment = '', include = F, message = F, fig.width = 6, fig.height = 6)

knitr::opts_chunk$set('label')


# Packages ----

# install.packages(c("tidyverse", "kableExtra", "arsenal", "finalfit", "tidyr", "broom"))
# optional extra package emojis devtools::install_github("hadley/emo")



```

```{r libraries, include = F, echo = F}

library(tidyverse)
library(kableExtra)
library(arsenal)
library(finalfit)

library(tidyr) #  for neater code output 
library(broom) # for tidying other models 

```

```{r data_prep, include = F, message = F, warning = F, eval = T}

# Ensure data is cleaned as much as possible and organised correctly (i.e. variables stored as needed e.g. factors, integers, double, characters)

glimpse(colon_s)

dim(colon_s)

head(colon_s, 10)

colon_s <- colon_s


```

# Table 1a: simple one-way table with default *tableby* options `r emo::ji("poop")`


```{r table1a_i, include = T, message = F, warning = F, eval = T}

table1a_i <- arsenal::tableby(~ age + age.factor + sex.factor + obstruct.factor + nodes,
          data = colon_s)

summary(table1a_i, text = T)

```

## Table 1a(ii): formatted `r emo::ji("smile")`

```{r table1a_ii, include = T, message = F, warning = F, results = 'asis', eval = T}

summary(table1a_i, text = T) %>%
  kable(format = "pandoc", 
        caption = "Formatted table", 
        padding = 0, 
        label = "", 
        align = c("l" , "c"), 
        col_order = order
        )

```

## Table 1b: add/modify human readable variable labels `r emo::ji("+1")``r emo::ji("+1")`

```{r table1b_code, include = T, message = F, warning = F, results = 'asis', echo = F, eval = T}

# See all variables labels and factor level names

labels(colon_s) %>%
  unlist()

# Change variable names and factor level names

labels(colon_s)  <- c(age = 'Age, yrs', sex = "Gender")

attr(colon_s$sex.factor, 'label')  <- 'Gender'

attr(colon_s$age.factor, 'label')  <- 'Age group'

colon_s$age.factor <- forcats::fct_relevel(colon_s$age.factor, rev)

```

```{r table1b_labels, include = T, message = F, warning = F, results = 'asis', eval = T}

table1b <- tableby(~ age + age.factor + sex.factor + obstruct.factor + nodes,
          data = colon_s)

summary(table1b, text = T) %>%
  kable(format = "pandoc", 
        caption = "Formatted table", 
        padding = 0, 
        label = "", 
        align = c("l" , "c"), 
        col_order = order
        ) 


```

## Table 1c: change default statistics and formatting `r emo::ji("+1")``r emo::ji("+1")``r emo::ji("+1")`

```{r table1c_options, include = T, message = F, warning = F, results = 'asis', eval = T}

tableby(~ age + age.factor + sex.factor + obstruct.factor + nodes,
          data = colon_s,
          digits = 1, 
          digits.pct = 1,
            control = tableby.control(cat.stats = c("countpct", "N", "Nmiss2"), 
                                      total = T, test = F,
                                      numeric.stats = c("meansd", "medianq1q3", "range", "N", "Nmiss2"), 
                                      stats.labels = list(Nmiss2 = "Number missing")
                                      )
          ) %>%
  summary(text = T) %>%
  kable(format = "pandoc", 
        caption = "Formatted table", 
        padding = 0, 
        label = "", 
        align = c("l" , "c"), 
        col_order = order
        )  


```

## Table 1d: more than one group `r emo::ji("flex")``r emo::ji("fist")``

```{r table1d_options, include = T, message = F, warning = F, results = 'asis', eval = T}

tableby(mort_5yr ~ age + age.factor + sex.factor + obstruct.factor + nodes + perfor.factor,
          data = colon_s,
          digits = 1, 
          digits.pct = 1,
            control = tableby.control(cat.stats = c("countrowpct", "N", "Nmiss2"), # now with row percentages
                                      total = T, test = T,
                                      numeric.stats = c("meansd", "medianq1q3", "range", "N", "Nmiss2"), 
                                      stats.labels = list(Nmiss2 = "Number missing")
                                      )
          ) %>%
  summary(text = T) %>%
  kable(format = "pandoc", 
        caption = "Formatted table", 
        padding = 0, 
        label = "", 
        align = c("l" , "c"), 
        col_order = order
        )  


```


## Table 1e: change default statistics, more than one group `r emo::ji("+1")``r emo::ji("+1")`

```{r table1e, include = T, message = F, warning = F, results = 'asis', eval = T}

tableby(mort_5yr ~ age + age.factor + sex.factor + obstruct.factor + nodes + perfor.factor,
          data = colon_s,
          digits = 1, 
          digits.pct = 1,
            control = tableby.control(cat.stats = c("countrowpct", "N", "Nmiss2"), # now with row percentages
                                      numeric.stats = c("meansd", "medianq1q3", "range", "N", "Nmiss2"), 
                                      stats.labels = list(Nmiss2 = "Number miss"),
                                      total = T, test = F
                                      )
          ) %>%
  summary(text = T) %>%
  kable(format = "pandoc", 
        caption = "Formatted table", 
        padding = 0, 
        label = "", 
        align = c("l" , "c"), 
        col_order = order
        )  


```

## Table 1f: Set global table options and create dataframe `r emo::ji("+1")`

```{r table_by global options, highlight = T, strip.white = T}

# Set global table options

mycontrols  <- tableby.control(test=FALSE, total=FALSE,
                               numeric.test="kwt", cat.test="chisq",
                               numeric.stats=c("meansd", "medianq1q3", "range", "N", "Nmiss2"),
                               cat.stats=c("countpct", "N", "Nmiss2"),
                               stats.labels=list(N = 'Count',
                                                 median = 'Median', 
                                                 q1q3 = 'Q1,Q3'),
                               digits = 1,
                               digits.pct = 1
                               )

# Create a table as data frame

table_1f <- tableby(mort_5yr ~ age + age.factor + sex.factor,
        data = colon_s,
          control = mycontrols) %>%
  summary(text = NULL) # set to null to remove any text formatting 

print(as.data.frame(table_1f))

```

*Other possibilities*
+ Subsets of groups (e.g. pregnant women)
   * Weighted estimates
   * Apply custom statistical tests for certain variables
   * Additional groupings by strata
   * Full list here: <https://cran.r-project.org/web/packages/arsenal/vignettes/tableby.html>

# Table 2: Odds ratio table
   
```{r  table 2, include = F,highlight = T, strip.white = T}

# FinalFirst package 

explanatory = c("age.factor", "sex.factor", "obstruct.factor", "perfor.factor")

dependent = "mort_5yr"

model_output1 <- colon_s %>%
    finalfit(dependent, explanatory, metrics = F)

```   

```{r  table_2out, include = T,highlight = T, strip.white = T}

model_output1 %>%
        kable(format = "pandoc", 
        caption = "", 
        padding = 0, 
        label = "", 
        align = c("l" , "c"), 
        col_order = order,
        row.names = NA,
        col.names = NA
        ) 
```   

*Lots of features and customisations*
   * Full list here: <https://finalfit.org/articles/all_tables_examples.html>
   